<!doctype html>
<html lang="fa" dir="rtl" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ناجی راه - چک‌لیست کامل خودرو</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800;900&amp;display=swap" rel="stylesheet">
  <style>
  html, body { height: 100%; margin: 0; padding: 0; }
  * { font-family: 'Vazirmatn', sans-serif; box-sizing: border-box; }

  :root {
    --bg-color: #0f172a;
    --surface-color: #1e293b;
    --text-color: #e2e8f0;
    --primary-color: #38bdf8;
    --secondary-color: #f59e0b;
  }

  body {
    background: var(--bg-color);
    color: var(--text-color);
  }

  .app-wrapper {
    width: 100%;
    height: 100%;
    overflow: auto;
    background: var(--bg-color);
    background-image:
      radial-gradient(ellipse at 20% 50%, rgba(56, 189, 248, 0.06) 0%, transparent 50%),
      radial-gradient(ellipse at 80% 20%, rgba(245, 158, 11, 0.04) 0%, transparent 50%);
  }

  .checklist-card {
    background: var(--surface-color);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 16px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .checklist-card::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 4px;
    height: 100%;
    background: var(--primary-color);
    opacity: 0.4;
    transition: opacity 0.3s;
  }

  .checklist-card.completed::before {
    background: #22c55e;
    opacity: 1;
  }

  .checklist-card.warning::before {
    background: var(--secondary-color);
    opacity: 1;
  }

  .checklist-card.danger::before {
    background: #ef4444;
    opacity: 1;
  }

  .input-field {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 10px;
    padding: 10px 14px;
    color: var(--text-color);
    font-family: 'Vazirmatn', sans-serif;
    font-size: 14px;
    width: 100%;
    transition: border-color 0.3s;
    direction: ltr;
    text-align: right;
  }

  .input-field:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.15);
  }

  .check-toggle {
    width: 48px;
    height: 26px;
    background: rgba(255,255,255,0.1);
    border-radius: 13px;
    position: relative;
    cursor: pointer;
    transition: background 0.3s;
    flex-shrink: 0;
  }

  .check-toggle.active {
    background: #22c55e;
  }

  .check-toggle::after {
    content: '';
    position: absolute;
    top: 3px;
    right: 3px;
    width: 20px;
    height: 20px;
    background: white;
    border-radius: 50%;
    transition: transform 0.3s;
  }

  .check-toggle.active::after {
    transform: translateX(-22px);
  }

  .guide-box {
    background: rgba(245, 158, 11, 0.08);
    border: 1px solid rgba(245, 158, 11, 0.2);
    border-radius: 12px;
    padding: 14px;
    margin-top: 12px;
    font-size: 13px;
    line-height: 2;
    display: none;
  }

  .guide-box.visible {
    display: block;
    animation: fadeSlide 0.3s ease;
  }

  .progress-ring {
    width: 120px;
    height: 120px;
    transform: rotate(-90deg);
  }

  .progress-ring circle {
    transition: stroke-dashoffset 0.6s ease;
  }

  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
  }

  .badge-ok { background: rgba(34,197,94,0.15); color: #22c55e; }
  .badge-warn { background: rgba(245,158,11,0.15); color: #f59e0b; }
  .badge-danger { background: rgba(239,68,68,0.15); color: #ef4444; }
  .badge-pending { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.4); }

  .btn-primary {
    background: var(--primary-color);
    color: #0f172a;
    border: none;
    border-radius: 12px;
    padding: 14px 28px;
    font-weight: 700;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s;
    font-family: 'Vazirmatn', sans-serif;
  }

  .btn-primary:hover {
    filter: brightness(1.1);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(56, 189, 248, 0.3);
  }

  .btn-secondary {
    background: var(--secondary-color);
    color: #0f172a;
    border: none;
    border-radius: 8px;
    padding: 6px 14px;
    font-weight: 600;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.3s;
    font-family: 'Vazirmatn', sans-serif;
  }

  .btn-secondary:hover {
    filter: brightness(1.1);
  }

  .btn-ghost {
    background: rgba(255,255,255,0.06);
    color: var(--text-color);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    padding: 6px 14px;
    font-weight: 500;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.3s;
    font-family: 'Vazirmatn', sans-serif;
  }

  .btn-ghost:hover {
    background: rgba(255,255,255,0.1);
  }

  @keyframes fadeSlide {
    from { opacity: 0; transform: translateY(-8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    20% { transform: translateX(-6px); }
    40% { transform: translateX(6px); }
    60% { transform: translateX(-4px); }
    80% { transform: translateX(4px); }
  }

  .shake { animation: shake 0.5s ease; }

  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(4px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 100;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
  }

  .modal-overlay.active {
    opacity: 1;
    pointer-events: all;
  }

  .result-modal {
    background: var(--surface-color);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 20px;
    padding: 30px;
    max-width: 440px;
    width: 90%;
    text-align: center;
    animation: fadeIn 0.4s ease;
  }

  .category-tab {
    padding: 8px 16px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
    white-space: nowrap;
    border: 1px solid transparent;
    background: rgba(255,255,255,0.04);
    color: rgba(255,255,255,0.5);
  }

  .category-tab.active {
    background: var(--primary-color);
    color: #0f172a;
    border-color: var(--primary-color);
  }

  .category-tab:hover:not(.active) {
    background: rgba(255,255,255,0.08);
    color: var(--text-color);
  }

  .car-icon {
    font-size: 48px;
    display: inline-block;
    animation: carBounce 2s ease infinite;
  }

  @keyframes carBounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-6px); }
  }

  .toast {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: var(--surface-color);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 12px 24px;
    font-size: 14px;
    font-weight: 600;
    z-index: 200;
    transition: transform 0.4s ease;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  }

  .toast.visible {
    transform: translateX(-50%) translateY(0);
  }

  /* Scrollbar styling */
  .app-wrapper::-webkit-scrollbar { width: 6px; }
  .app-wrapper::-webkit-scrollbar-track { background: transparent; }
  .app-wrapper::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
  .app-wrapper::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
</style>
  <style>body { box-sizing: border-box; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div class="app-wrapper" id="appWrapper"><!-- Landing View -->
   <div id="landingView" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; padding:24px; text-align:center;">
    <div class="car-icon">
     🚗
    </div>
    <h1 id="appTitle" style="font-size:32px; font-weight:900; margin:16px 0 8px; background:linear-gradient(135deg, var(--primary-color), var(--secondary-color)); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">ناجی راه</h1>
    <p style="color:rgba(255,255,255,0.5); margin-bottom:32px; font-size:15px;" id="appSubtitle">خودرو خود را قبل از سفر بررسی کنید</p><button class="btn-primary" id="startBtn" onclick="showChecklist()" style="font-size:18px; padding:16px 36px;"> 🚗 باز کردن چک‌لیست خودرو </button>
    <div style="margin-top:40px; display:flex; gap:24px; color:rgba(255,255,255,0.3); font-size:13px;"><span>✅ ۸ دسته بررسی</span> <span>📋 ۲۰+ آیتم</span> <span>🛡️ ایمنی کامل</span>
    </div>
   </div><!-- Checklist View -->
   <div id="checklistView" style="display:none; padding:16px; max-width:640px; margin:0 auto;"><!-- Header -->
    <header style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; padding:16px 0;">
     <div>
      <h2 id="checklistTitle" style="font-size:20px; font-weight:800; margin:0; color:var(--primary-color);">چک‌لیست کامل قبل از سفر</h2>
      <p style="font-size:13px; color:rgba(255,255,255,0.4); margin:4px 0 0;">تمام موارد را بررسی کنید</p>
     </div><button class="btn-ghost" onclick="goBack()" aria-label="بازگشت">✕</button>
    </header><!-- Progress Section -->
    <div style="display:flex; align-items:center; gap:20px; background:var(--surface-color); border-radius:16px; padding:20px; margin-bottom:20px; border:1px solid rgba(255,255,255,0.06);">
     <div style="position:relative;">
      <svg class="progress-ring" viewbox="0 0 120 120"><circle cx="60" cy="60" r="52" fill="none" stroke="rgba(255,255,255,0.06)" stroke-width="8" /> <circle id="progressCircle" cx="60" cy="60" r="52" fill="none" stroke="var(--primary-color)" stroke-width="8" stroke-linecap="round" stroke-dasharray="326.73" stroke-dashoffset="326.73" />
      </svg>
      <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%) rotate(90deg); text-align:center;">
       <div id="progressPercent" style="font-size:28px; font-weight:900; color:var(--primary-color);">
        0%
       </div>
      </div>
     </div>
     <div style="flex:1;">
      <div style="font-size:14px; font-weight:700; margin-bottom:8px;">
       وضعیت بررسی
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;"><span id="okCount" class="status-badge badge-ok">✓ ۰ تأیید</span> <span id="warnCount" class="status-badge badge-warn">⚠ ۰ هشدار</span> <span id="dangerCount" class="status-badge badge-danger">✕ ۰ خطر</span>
      </div>
      <div style="font-size:12px; color:rgba(255,255,255,0.3); margin-top:8px;" id="pendingText">
       ۲۰ مورد باقیمانده
      </div>
     </div>
    </div><!-- Category Tabs -->
    <nav style="display:flex; gap:8px; overflow-x:auto; padding-bottom:12px; margin-bottom:16px;" id="categoryTabs" aria-label="دسته‌بندی‌ها">
    </nav><!-- Checklist Items -->
    <main id="checklistItems" role="list" aria-label="آیتم‌های چک‌لیست">
    </main><!-- Submit Button -->
    <div style="padding:20px 0; text-align:center;"><button class="btn-primary" onclick="submitChecklist()" style="width:100%; padding:16px;"> 📊 مشاهده نتیجه نهایی </button>
    </div>
   </div>
  </div><!-- Result Modal -->
  <div class="modal-overlay" id="resultModal">
   <div class="result-modal" role="dialog" aria-modal="true" aria-label="نتیجه بررسی">
    <div id="resultIcon" style="font-size:64px; margin-bottom:16px;">
     🚗
    </div>
    <h3 id="resultTitle" style="font-size:22px; font-weight:800; margin:0 0 8px;"></h3>
    <p id="resultDesc" style="color:rgba(255,255,255,0.5); font-size:14px; margin-bottom:24px;"></p>
    <div id="resultDetails" style="text-align:right; margin-bottom:24px;"></div>
    <div style="display:flex; gap:12px; justify-content:center;"><button class="btn-primary" onclick="closeResult()">بستن</button> <button class="btn-ghost" onclick="resetChecklist()">شروع مجدد</button>
    </div>
   </div>
  </div><!-- Toast -->
  <div class="toast" id="toast"></div>
  <script>
// ====== DATA ======
const categories = [
  { id: 'tires', name: 'لاستیک', icon: '🛞' },
  { id: 'engine', name: 'موتور و روغن', icon: '🛢️' },
  { id: 'brakes', name: 'ترمز', icon: '🛑' },
  { id: 'lights', name: 'چراغ‌ها', icon: '💡' },
  { id: 'fluids', name: 'مایعات', icon: '💧' },
  { id: 'safety', name: 'ایمنی', icon: '🛡️' },
  { id: 'electric', name: 'برق و باتری', icon: '🔋' },
  { id: 'body', name: 'بدنه و شیشه', icon: '🪟' }
];

const checklistData = [
  // Tires
  { id: 'tire_pressure', cat: 'tires', label: 'فشار باد لاستیک (PSI)', type: 'number', placeholder: 'مثلاً ۳۲', min: 28, max: 36, warnMin: 30, warnMax: 35,
    guide: 'فشار باد استاندارد بین ۳۰ تا ۳۵ PSI است. فشار کم باعث سایش لبه‌ها و فشار زیاد باعث سایش وسط لاستیک می‌شود.' },
  { id: 'tire_tread', cat: 'tires', label: 'عمق آج لاستیک (میلی‌متر)', type: 'number', placeholder: 'مثلاً ۳', min: 1.6, max: 12, warnMin: 2, warnMax: 10,
    guide: 'حداقل عمق آج قانونی ۱.۶ میلی‌متر است. برای ایمنی بهتر حداقل ۳ میلی‌متر توصیه می‌شود. با سکه ۱۰۰ تومانی تست کنید.' },
  { id: 'spare_tire', cat: 'tires', label: 'زاپاس سالم و باد دارد', type: 'toggle',
    guide: 'زاپاس را هر ۶ ماه بررسی کنید. فشار باد زاپاس معمولاً ۶۰ PSI است.' },

  // Engine
  { id: 'oil_level', cat: 'engine', label: 'سطح روغن موتور (%)', type: 'number', placeholder: 'مثلاً ۷۰', min: 30, max: 100, warnMin: 50, warnMax: 100,
    guide: 'گیج روغن را در حالت خاموش و سطح صاف بررسی کنید. روغن باید بین خط Min و Max باشد.' },
  { id: 'oil_color', cat: 'engine', label: 'رنگ روغن شفاف است (سیاه نیست)', type: 'toggle',
    guide: 'روغن تازه عسلی شفاف است. اگر سیاه و کدر شده، زمان تعویض رسیده.' },
  { id: 'engine_temp', cat: 'engine', label: 'دمای موتور نرمال است', type: 'toggle',
    guide: 'دمای نرمال موتور بین ۸۰ تا ۱۰۰ درجه سانتیگراد است. عقربه دما باید در وسط باشد.' },

  // Brakes
  { id: 'brake_pad', cat: 'brakes', label: 'ضخامت لنت ترمز (میلی‌متر)', type: 'number', placeholder: 'مثلاً ۵', min: 2, max: 15, warnMin: 3, warnMax: 12,
    guide: 'حداقل ضخامت لنت ۳ میلی‌متر باشد. اگر صدای جیغ می‌دهد حتماً بررسی کنید.' },
  { id: 'brake_fluid', cat: 'brakes', label: 'سطح روغن ترمز مناسب است', type: 'toggle',
    guide: 'روغن ترمز باید بین Min و Max باشد. هر ۲ سال تعویض شود.' },
  { id: 'handbrake', cat: 'brakes', label: 'ترمز دستی عملکرد صحیح دارد', type: 'toggle',
    guide: 'ترمز دستی باید در ۳ تا ۵ کلیک کاملاً قفل شود.' },

  // Lights
  { id: 'headlights', cat: 'lights', label: 'چراغ جلو (نور بالا و پایین)', type: 'toggle',
    guide: 'هر دو چراغ باید سالم و تنظیم باشند. نور نباید در چشم مقابل بزند.' },
  { id: 'taillights', cat: 'lights', label: 'چراغ عقب و ترمز', type: 'toggle',
    guide: 'از کسی بخواهید ترمز بزنید و چراغ‌ها را بررسی کنید.' },
  { id: 'signals', cat: 'lights', label: 'راهنماها و چراغ خطر', type: 'toggle',
    guide: 'تمام ۴ راهنما و چراغ خطر باید کار کنند. سرعت چشمک‌زنی یکنواخت باشد.' },

  // Fluids
  { id: 'coolant', cat: 'fluids', label: 'سطح ضدیخ/کولانت مناسب', type: 'toggle',
    guide: 'مخزن ضدیخ را در حالت سرد بررسی کنید. هرگز درب رادیاتور داغ را باز نکنید!' },
  { id: 'washer_fluid', cat: 'fluids', label: 'مایع شیشه‌شوی کافی', type: 'toggle',
    guide: 'مایع شیشه‌شوی حتماً با ضدیخ مخصوص پر شود. از آب استفاده نکنید.' },
  { id: 'power_steering', cat: 'fluids', label: 'روغن هیدرولیک فرمان', type: 'toggle',
    guide: 'اگر فرمان سنگین شده یا صدا می‌دهد، روغن هیدرولیک را بررسی کنید.' },

  // Safety
  { id: 'first_aid', cat: 'safety', label: 'کیت کمک‌های اولیه موجود', type: 'toggle',
    guide: 'کیت باید شامل باند، بتادین، قیچی، دستکش و چسب زخم باشد.' },
  { id: 'fire_ext', cat: 'safety', label: 'کپسول آتش‌نشانی معتبر', type: 'toggle',
    guide: 'تاریخ انقضا و فشار سنج کپسول را بررسی کنید. هر سال شارژ شود.' },
  { id: 'triangle', cat: 'safety', label: 'مثلث خطر و جلیقه شبرنگ', type: 'toggle',
    guide: 'مثلث خطر باید ۵۰ متر پشت خودرو قرار گیرد. جلیقه شبرنگ الزامی است.' },

  // Electric
  { id: 'battery', cat: 'electric', label: 'ولتاژ باتری (ولت)', type: 'number', placeholder: 'مثلاً ۱۲.۶', min: 11.5, max: 14.5, warnMin: 12.2, warnMax: 14,
    guide: 'ولتاژ نرمال باتری خاموش ۱۲.۴-۱۲.۷ ولت و روشن ۱۳.۵-۱۴.۵ ولت است.' },
  { id: 'ac_works', cat: 'electric', label: 'کولر/بخاری کار می‌کند', type: 'toggle',
    guide: 'کولر باید هوای سرد بدهد و بخاری در عرض ۵ دقیقه گرم شود.' },

  // Body
  { id: 'wipers', cat: 'body', label: 'برف‌پاک‌کن سالم', type: 'toggle',
    guide: 'تیغه‌ها نباید خط بیندازند. هر ۶ تا ۱۲ ماه تعویض شوند.' },
  { id: 'mirrors', cat: 'body', label: 'آینه‌ها تنظیم و سالم', type: 'toggle',
    guide: 'آینه بغل باید لبه خودرو و خط بعدی را نشان دهد. آینه وسط کل شیشه عقب.' },
  { id: 'windshield', cat: 'body', label: 'شیشه جلو بدون ترک', type: 'toggle',
    guide: 'هر ترک کوچک با لرزش جاده بزرگ‌تر می‌شود. سریعاً ترمیم کنید.' }
];

// ====== STATE ======
let currentCategory = 'all';
let itemStates = {};

// Initialize all items
checklistData.forEach(item => {
  itemStates[item.id] = { value: item.type === 'toggle' ? false : null, status: 'pending' };
});

// ====== CONFIG ======
const defaultConfig = {
  app_title: 'ناجی راه',
  checklist_title: 'چک‌لیست کامل قبل از سفر',
  start_button_text: 'باز کردن چک‌لیست خودرو',
  background_color: '#0f172a',
  surface_color: '#1e293b',
  text_color: '#e2e8f0',
  primary_color: '#38bdf8',
  secondary_color: '#f59e0b',
  font_family: 'Vazirmatn',
  font_size: 16
};

function applyConfig(config) {
  const bg = config.background_color || defaultConfig.background_color;
  const surface = config.surface_color || defaultConfig.surface_color;
  const text = config.text_color || defaultConfig.text_color;
  const primary = config.primary_color || defaultConfig.primary_color;
  const secondary = config.secondary_color || defaultConfig.secondary_color;
  const fontFamily = config.font_family || defaultConfig.font_family;
  const fontSize = config.font_size || defaultConfig.font_size;

  document.documentElement.style.setProperty('--bg-color', bg);
  document.documentElement.style.setProperty('--surface-color', surface);
  document.documentElement.style.setProperty('--text-color', text);
  document.documentElement.style.setProperty('--primary-color', primary);
  document.documentElement.style.setProperty('--secondary-color', secondary);

  document.body.style.background = bg;
  document.body.style.color = text;
  const wrapper = document.getElementById('appWrapper');
  if (wrapper) wrapper.style.background = bg;

  // Font
  const stack = `${fontFamily}, Vazirmatn, sans-serif`;
  document.body.style.fontFamily = stack;

  // Font size
  const base = fontSize;
  const appTitleEl = document.getElementById('appTitle');
  if (appTitleEl) {
    appTitleEl.style.fontSize = `${base * 2}px`;
    appTitleEl.style.fontFamily = stack;
  }

  const checkTitleEl = document.getElementById('checklistTitle');
  if (checkTitleEl) {
    checkTitleEl.style.fontSize = `${base * 1.25}px`;
    checkTitleEl.style.fontFamily = stack;
  }

  // Texts
  const title = config.app_title || defaultConfig.app_title;
  const clTitle = config.checklist_title || defaultConfig.checklist_title;
  const btnText = config.start_button_text || defaultConfig.start_button_text;

  if (appTitleEl) appTitleEl.textContent = title;
  if (checkTitleEl) checkTitleEl.textContent = clTitle;
  const startBtnEl = document.getElementById('startBtn');
  if (startBtnEl) startBtnEl.textContent = '🚗 ' + btnText;
}

// ====== SDK INIT ======
if (window.elementSdk) {
  window.elementSdk.init({
    defaultConfig,
    onConfigChange: async (config) => {
      applyConfig(config);
    },
    mapToCapabilities: (config) => ({
      recolorables: [
        {
          get: () => config.background_color || defaultConfig.background_color,
          set: (v) => { config.background_color = v; window.elementSdk.setConfig({ background_color: v }); }
        },
        {
          get: () => config.surface_color || defaultConfig.surface_color,
          set: (v) => { config.surface_color = v; window.elementSdk.setConfig({ surface_color: v }); }
        },
        {
          get: () => config.text_color || defaultConfig.text_color,
          set: (v) => { config.text_color = v; window.elementSdk.setConfig({ text_color: v }); }
        },
        {
          get: () => config.primary_color || defaultConfig.primary_color,
          set: (v) => { config.primary_color = v; window.elementSdk.setConfig({ primary_color: v }); }
        },
        {
          get: () => config.secondary_color || defaultConfig.secondary_color,
          set: (v) => { config.secondary_color = v; window.elementSdk.setConfig({ secondary_color: v }); }
        }
      ],
      borderables: [],
      fontEditable: {
        get: () => config.font_family || defaultConfig.font_family,
        set: (v) => { config.font_family = v; window.elementSdk.setConfig({ font_family: v }); }
      },
      fontSizeable: {
        get: () => config.font_size || defaultConfig.font_size,
        set: (v) => { config.font_size = v; window.elementSdk.setConfig({ font_size: v }); }
      }
    }),
    mapToEditPanelValues: (config) => new Map([
      ['app_title', config.app_title || defaultConfig.app_title],
      ['checklist_title', config.checklist_title || defaultConfig.checklist_title],
      ['start_button_text', config.start_button_text || defaultConfig.start_button_text]
    ])
  });
}

// Apply defaults on load
applyConfig(defaultConfig);

// ====== NAVIGATION ======
function showChecklist() {
  document.getElementById('landingView').style.display = 'none';
  document.getElementById('checklistView').style.display = 'block';
  buildCategoryTabs();
  renderItems();
  updateProgress();
}

function goBack() {
  document.getElementById('checklistView').style.display = 'none';
  document.getElementById('landingView').style.display = 'flex';
}

// ====== CATEGORY TABS ======
function buildCategoryTabs() {
  const container = document.getElementById('categoryTabs');
  container.innerHTML = '';

  const allTab = document.createElement('button');
  allTab.className = 'category-tab active';
  allTab.textContent = '📋 همه';
  allTab.setAttribute('aria-pressed', 'true');
  allTab.onclick = () => switchCategory('all');
  allTab.dataset.catId = 'all';
  container.appendChild(allTab);

  categories.forEach(cat => {
    const tab = document.createElement('button');
    tab.className = 'category-tab';
    tab.textContent = `${cat.icon} ${cat.name}`;
    tab.setAttribute('aria-pressed', 'false');
    tab.onclick = () => switchCategory(cat.id);
    tab.dataset.catId = cat.id;
    container.appendChild(tab);
  });
}

function switchCategory(catId) {
  currentCategory = catId;
  document.querySelectorAll('.category-tab').forEach(tab => {
    const isActive = tab.dataset.catId === catId;
    tab.classList.toggle('active', isActive);
    tab.setAttribute('aria-pressed', isActive ? 'true' : 'false');
  });
  renderItems();
}

// ====== RENDER ITEMS ======
function renderItems() {
  const container = document.getElementById('checklistItems');
  container.innerHTML = '';

  const items = currentCategory === 'all'
    ? checklistData
    : checklistData.filter(i => i.cat === currentCategory);

  items.forEach(item => {
    const state = itemStates[item.id];
    const card = document.createElement('div');
    card.className = 'checklist-card';
    card.id = `card-${item.id}`;
    card.setAttribute('role', 'listitem');

    if (state.status === 'ok') card.classList.add('completed');
    else if (state.status === 'warn') card.classList.add('warning');
    else if (state.status === 'danger') card.classList.add('danger');

    const cat = categories.find(c => c.id === item.cat);

    let inputHtml = '';
    if (item.type === 'number') {
      inputHtml = `
        <div style="display:flex; align-items:center; gap:10px; margin-top:10px;">
          <label for="input-${item.id}" class="sr-only">${item.label}</label>
          <input id="input-${item.id}" class="input-field" type="number" step="any"
            placeholder="${item.placeholder || ''}"
            value="${state.value !== null ? state.value : ''}"
            oninput="handleNumberInput('${item.id}', this.value)"
            style="max-width:160px;">
          <span id="badge-${item.id}" class="status-badge ${getBadgeClass(state.status)}">${getBadgeText(state.status)}</span>
        </div>`;
    } else {
      inputHtml = `
        <div style="display:flex; align-items:center; gap:12px; margin-top:10px;">
          <div class="check-toggle ${state.value ? 'active' : ''}" id="toggle-${item.id}"
            onclick="handleToggle('${item.id}')" role="switch" aria-checked="${state.value}" tabindex="0"
            aria-label="${item.label}"
            onkeydown="if(event.key===' '||event.key==='Enter'){event.preventDefault();handleToggle('${item.id}')}"></div>
          <span style="font-size:13px; color:${state.value ? '#22c55e' : 'rgba(255,255,255,0.4)'};">${state.value ? '✓ تأیید شد' : 'بررسی نشده'}</span>
        </div>`;
    }

    card.innerHTML = `
      <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px;">
        <div style="flex:1;">
          <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
            <span style="font-size:20px;">${cat.icon}</span>
            <span style="font-size:15px; font-weight:700;">${item.label}</span>
          </div>
          ${inputHtml}
        </div>
        <button class="btn-secondary" onclick="toggleGuide('${item.id}')" aria-expanded="false" id="guideBtn-${item.id}">❓ راهنما</button>
      </div>
      <div class="guide-box" id="guide-${item.id}">
        <strong style="color:var(--secondary-color);">💡 راهنما:</strong><br>
        ${item.guide}
      </div>`;

    container.appendChild(card);
  });
}

// ====== HANDLERS ======
function handleNumberInput(id, rawValue) {
  const item = checklistData.find(i => i.id === id);
  const value = parseFloat(rawValue);

  if (rawValue === '' || isNaN(value)) {
    itemStates[id] = { value: null, status: 'pending' };
  } else if (value < item.min || value > item.max) {
    itemStates[id] = { value, status: 'danger' };
  } else if (value < item.warnMin || value > item.warnMax) {
    itemStates[id] = { value, status: 'warn' };
  } else {
    itemStates[id] = { value, status: 'ok' };
  }

  // Update badge inline
  const badge = document.getElementById(`badge-${id}`);
  if (badge) {
    badge.className = `status-badge ${getBadgeClass(itemStates[id].status)}`;
    badge.textContent = getBadgeText(itemStates[id].status);
  }

  // Update card border
  const card = document.getElementById(`card-${id}`);
  if (card) {
    card.classList.remove('completed', 'warning', 'danger');
    if (itemStates[id].status === 'ok') card.classList.add('completed');
    else if (itemStates[id].status === 'warn') card.classList.add('warning');
    else if (itemStates[id].status === 'danger') card.classList.add('danger');
  }

  updateProgress();
}

function handleToggle(id) {
  const current = itemStates[id].value;
  itemStates[id] = { value: !current, status: !current ? 'ok' : 'pending' };

  const toggle = document.getElementById(`toggle-${id}`);
  if (toggle) {
    toggle.classList.toggle('active', !current);
    toggle.setAttribute('aria-checked', String(!current));
    const label = toggle.nextElementSibling;
    if (label) {
      label.textContent = !current ? '✓ تأیید شد' : 'بررسی نشده';
      label.style.color = !current ? '#22c55e' : 'rgba(255,255,255,0.4)';
    }
  }

  const card = document.getElementById(`card-${id}`);
  if (card) {
    card.classList.remove('completed', 'warning', 'danger');
    if (!current) card.classList.add('completed');
  }

  updateProgress();
}

function toggleGuide(id) {
  const box = document.getElementById(`guide-${id}`);
  const btn = document.getElementById(`guideBtn-${id}`);
  if (box) {
    const isVisible = box.classList.contains('visible');
    box.classList.toggle('visible');
    if (btn) btn.setAttribute('aria-expanded', String(!isVisible));
  }
}

// ====== PROGRESS ======
function updateProgress() {
  const total = checklistData.length;
  let ok = 0, warn = 0, danger = 0, pending = 0;

  Object.values(itemStates).forEach(s => {
    if (s.status === 'ok') ok++;
    else if (s.status === 'warn') warn++;
    else if (s.status === 'danger') danger++;
    else pending++;
  });

  const completed = ok + warn + danger;
  const percent = Math.round((completed / total) * 100);

  // Circle
  const circle = document.getElementById('progressCircle');
  const circumference = 2 * Math.PI * 52;
  if (circle) {
    circle.style.strokeDashoffset = circumference - (circumference * percent / 100);
  }

  const percentEl = document.getElementById('progressPercent');
  if (percentEl) percentEl.textContent = toPersianNum(percent) + '%';

  const okEl = document.getElementById('okCount');
  if (okEl) okEl.textContent = '✓ ' + toPersianNum(ok) + ' تأیید';

  const warnEl = document.getElementById('warnCount');
  if (warnEl) warnEl.textContent = '⚠ ' + toPersianNum(warn) + ' هشدار';

  const dangerEl = document.getElementById('dangerCount');
  if (dangerEl) dangerEl.textContent = '✕ ' + toPersianNum(danger) + ' خطر';

  const pendingEl = document.getElementById('pendingText');
  if (pendingEl) pendingEl.textContent = toPersianNum(pending) + ' مورد باقیمانده';
}

// ====== SUBMIT ======
function submitChecklist() {
  let ok = 0, warn = 0, danger = 0, pending = 0;
  const issues = [];

  checklistData.forEach(item => {
    const s = itemStates[item.id];
    if (s.status === 'ok') ok++;
    else if (s.status === 'warn') { warn++; issues.push({ item, status: 'warn' }); }
    else if (s.status === 'danger') { danger++; issues.push({ item, status: 'danger' }); }
    else { pending++; issues.push({ item, status: 'pending' }); }
  });

  const total = checklistData.length;
  const modal = document.getElementById('resultModal');
  const iconEl = document.getElementById('resultIcon');
  const titleEl = document.getElementById('resultTitle');
  const descEl = document.getElementById('resultDesc');
  const detailsEl = document.getElementById('resultDetails');

  if (danger > 0) {
    iconEl.textContent = '🚨';
    titleEl.textContent = 'خودرو آماده سفر نیست!';
    titleEl.style.color = '#ef4444';
    descEl.textContent = `${toPersianNum(danger)} مورد خطرناک شناسایی شد. قبل از سفر حتماً رفع کنید.`;
  } else if (warn > 0) {
    iconEl.textContent = '⚠️';
    titleEl.textContent = 'سفر با احتیاط';
    titleEl.style.color = '#f59e0b';
    descEl.textContent = `${toPersianNum(warn)} مورد هشدار وجود دارد. توصیه می‌شود قبل از سفر بررسی شود.`;
  } else if (pending > 0) {
    iconEl.textContent = '📋';
    titleEl.textContent = 'بررسی ناقص';
    titleEl.style.color = 'var(--primary-color)';
    descEl.textContent = `${toPersianNum(pending)} مورد هنوز بررسی نشده. لطفاً تمام موارد را کامل کنید.`;
  } else {
    iconEl.textContent = '🎉';
    titleEl.textContent = 'خودرو آماده سفر است!';
    titleEl.style.color = '#22c55e';
    descEl.textContent = 'تمام موارد بررسی شد و مشکلی وجود ندارد. سفر خوبی داشته باشید!';
  }

  // Details
  let detailsHtml = `
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:16px;">
      <div style="background:rgba(34,197,94,0.1); padding:12px; border-radius:10px; text-align:center;">
        <div style="font-size:24px; font-weight:900; color:#22c55e;">${toPersianNum(ok)}</div>
        <div style="font-size:12px; color:rgba(255,255,255,0.5);">تأیید شده</div>
      </div>
      <div style="background:rgba(245,158,11,0.1); padding:12px; border-radius:10px; text-align:center;">
        <div style="font-size:24px; font-weight:900; color:#f59e0b;">${toPersianNum(warn)}</div>
        <div style="font-size:12px; color:rgba(255,255,255,0.5);">هشدار</div>
      </div>
      <div style="background:rgba(239,68,68,0.1); padding:12px; border-radius:10px; text-align:center;">
        <div style="font-size:24px; font-weight:900; color:#ef4444;">${toPersianNum(danger)}</div>
        <div style="font-size:12px; color:rgba(255,255,255,0.5);">خطر</div>
      </div>
      <div style="background:rgba(255,255,255,0.04); padding:12px; border-radius:10px; text-align:center;">
        <div style="font-size:24px; font-weight:900; color:rgba(255,255,255,0.4);">${toPersianNum(pending)}</div>
        <div style="font-size:12px; color:rgba(255,255,255,0.5);">بررسی نشده</div>
      </div>
    </div>`;

  if (issues.length > 0 && issues.length <= 10) {
    detailsHtml += '<div style="font-size:13px; font-weight:700; margin-bottom:8px;">موارد نیازمند توجه:</div>';
    issues.forEach(({ item, status }) => {
      const cat = categories.find(c => c.id === item.cat);
      const color = status === 'danger' ? '#ef4444' : status === 'warn' ? '#f59e0b' : 'rgba(255,255,255,0.4)';
      const symbol = status === 'danger' ? '✕' : status === 'warn' ? '⚠' : '○';
      detailsHtml += `<div style="display:flex; align-items:center; gap:8px; padding:6px 0; font-size:13px; border-bottom:1px solid rgba(255,255,255,0.04);">
        <span style="color:${color}; font-weight:700;">${symbol}</span>
        <span>${cat.icon} ${item.label}</span>
      </div>`;
    });
  }

  detailsEl.innerHTML = detailsHtml;
  modal.classList.add('active');
}

function closeResult() {
  document.getElementById('resultModal').classList.remove('active');
}

function resetChecklist() {
  checklistData.forEach(item => {
    itemStates[item.id] = { value: item.type === 'toggle' ? false : null, status: 'pending' };
  });
  closeResult();
  renderItems();
  updateProgress();
  showToast('چک‌لیست از نو شروع شد ✨');
}

// ====== HELPERS ======
function getBadgeClass(status) {
  if (status === 'ok') return 'badge-ok';
  if (status === 'warn') return 'badge-warn';
  if (status === 'danger') return 'badge-danger';
  return 'badge-pending';
}

function getBadgeText(status) {
  if (status === 'ok') return '✓ مناسب';
  if (status === 'warn') return '⚠ هشدار';
  if (status === 'danger') return '✕ خطر';
  return '○ بررسی نشده';
}

function toPersianNum(num) {
  const persianDigits = ['۰','۱','۲','۳','۴','۵','۶','۷','۸','۹'];
  return String(num).replace(/\d/g, d => persianDigits[d]);
}

function showToast(msg) {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.classList.add('visible');
  setTimeout(() => toast.classList.remove('visible'), 2500);
}
</script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ce8410d904dd243',t:'MTc3MTE5NDY3Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>