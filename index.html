<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÛŒØ¯Ú©â€ŒÚ©Ø´ / Ù…Ú©Ø§Ù†ÛŒÚ© Ø³ÛŒØ§Ø±</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body {
  font-family: 'Tahoma', sans-serif;
  background: linear-gradient(135deg, #f2f2f2, #e0e0e0);
  margin:0; padding:0;
}
form {
  max-width:450px;
  margin:40px auto;
  background:#fff;
  padding:25px;
  border-radius:15px;
  box-shadow:0 8px 20px rgba(0,0,0,0.1);
  transition: transform 0.2s;
}
form:hover { transform: translateY(-3px); }
h3 {
  text-align:center;
  margin-bottom:20px;
  color:#333;
  font-size:1.6em;
}
input, select, textarea, button {
  width:100%;
  margin-top:12px;
  padding:12px;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:1em;
  transition: border 0.2s, box-shadow 0.2s;
}
input:focus, select:focus, textarea:focus {
  border-color: #28a745;
  box-shadow:0 0 5px rgba(40,167,69,0.4);
  outline:none;
}
textarea { resize: vertical; min-height:80px; }
button {
  border:none; cursor:pointer; font-weight:bold; margin-top:10px; transition:0.3s;
}
button:hover { opacity:0.9; }
button.loc { background:#007bff; color:#fff; }
button.submit { background:#28a745; color:#fff; }
#map { height:300px; margin-top:10px; display:none; border-radius:8px; }
</style>
</head>
<body>

<form id="form">
  <h3>Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø®Ø¯Ù…Ø§Øª</h3>

  <select name="service" required>
    <option value="">Ù†ÙˆØ¹ Ø®Ø¯Ù…Ø§Øª</option>
    <option value="ÛŒØ¯Ú©â€ŒÚ©Ø´">ÛŒØ¯Ú©â€ŒÚ©Ø´</option>
    <option value="Ù…Ú©Ø§Ù†ÛŒÚ© Ø³ÛŒØ§Ø±">Ù…Ú©Ø§Ù†ÛŒÚ© Ø³ÛŒØ§Ø±</option>
  </select>

  <input name="name" placeholder="Ù†Ø§Ù…" required>
  <input name="phone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³" required>
  <input name="plate" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ù¾Ù„Ø§Ú©" required>
  <textarea name="desc" placeholder="ØªÙˆØ¶ÛŒØ­ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)"></textarea>

  <input type="hidden" name="lat" id="lat">
  <input type="hidden" name="lon" id="lon">

  <button type="button" class="loc" onclick="showMap()">ğŸ“ Ø§Ù†ØªØ®Ø§Ø¨ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡</button>
  <div id="map"></div>

  <button type="submit" class="submit">Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</button>
</form>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let map, marker;

function showMap(){
  const mapDiv = document.getElementById("map");
  mapDiv.style.display = "block";

  if(!map){
    map = L.map('map').setView([35.7, 51.4], 13); // Ù…Ø±Ú©Ø² ØªÙ‡Ø±Ø§Ù† Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ø«Ø§Ù„

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);

    map.on('click', function(e){
      const {lat, lng} = e.latlng;

      if(marker) map.removeLayer(marker);
      marker = L.marker([lat,lng]).addTo(map);

      document.getElementById("lat").value = lat;
      document.getElementById("lon").value = lng;
    });
  }
}

document.getElementById("form").onsubmit = async e => {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target));

  if(!data.lat || !data.lon){
    alert("Ù„Ø·ÙØ§Ù‹ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø®ÙˆØ¯ Ø±Ø§ Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ğŸ“");
    return;
  }

  try {
    const res = await fetch("/api/submit",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify(data)
    });
    const result = await res.json();
    if(result.status === "ok") {
      alert("Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø«Ø¨Øª Ø´Ø¯ âœ…");
      e.target.reset();
      document.getElementById("map").style.display = "none";
      if(marker) marker.remove();
    } else {
      alert("Ø®Ø·Ø§: " + result.message);
    }
  } catch(err) {
    alert("Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡: " + err.message);
  }
};
</script>

</body>
</html>
